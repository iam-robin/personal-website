---
import { db, Postcard, desc, eq } from "astro:db";
import {
    isValidCountry,
    getStandardCountryName,
    getCountryFlag,
} from "@utils/countries";
import PostcardsSection from "./PostcardsSection.astro";
import WorldMapDetail from "./WorldMapDetail.astro";
import Layout from "@layouts/Layout.astro";
import TagCloud from "@components/TagCloud.astro";
import Container from "@components/Container.astro";
import HeadlineParagraphSection from "@components/HeadlineParagraphSection.astro";
import { Image } from "astro:assets";
import robinCoffee from "@assets/illustrations/robin-coffee.png";
import Grid from "@components/Grid.astro";
import GridItem from "@components/GridItem.astro";

interface Props {
    selectedCountry?: string;
}

const { selectedCountry } = Astro.props;

// Fetch all postcards
const allPostcards = await db
    .select()
    .from(Postcard)
    .where(eq(Postcard.isPublished, true))
    .orderBy(desc(Postcard.date));

// Filter postcards based on selectedCountry
const displayedPostcards = selectedCountry
    ? allPostcards.filter(
          (p) =>
              p.country &&
              getStandardCountryName(p.country) === selectedCountry,
      )
    : allPostcards;

// Process countries from ALL postcards for TagCloud
const allCountries = allPostcards
    .map((postcard) => postcard.country)
    .filter((country) => country !== null && country !== undefined);

const countryCounts = allCountries.reduce(
    (acc, country) => {
        if (isValidCountry(country!)) {
            const standardName = getStandardCountryName(country!);
            acc[standardName] = (acc[standardName] || 0) + 1;
        }
        return acc;
    },
    {} as Record<string, number>,
);

const countryCloudData = Object.entries(countryCounts).map(([name, count]) => ({
    name,
    count,
    flag: getCountryFlag(name),
}));

const visitedCountries = countryCloudData.map((country) => country.name);
---

<Layout ogImage="/opengraph/postcards.jpg">
    <HeadlineParagraphSection
        title="Postcards"
        class="py-32"
        linkText="Send Postcard"
        linkUrl="/postcards/new"
        buttonStyle={true}
        isFirstElement
    >
        I love the idea of people stopping by and leaving a trace — something
        small that makes this website feel a little more alive. It's like a
        guestbook, just a bit more personal.
    </HeadlineParagraphSection>
    <Container>
        <TagCloud
            tags={countryCloudData}
            selectedTag={selectedCountry}
            basePath="/postcards"
            filterPath="country"
            filterLabel="country"
            total={allPostcards.length}
        />
    </Container>
    <PostcardsSection postcards={displayedPostcards} hasDescription={false} />
    <Container class="mt-8 md:mt-24">
        <WorldMapDetail visitedCountries={visitedCountries} />
    </Container>
    <Container class="mt-8 md:mt-24">
        <Grid class="flex items-center">
            <GridItem
                colStart={{ small: 1, medium: 1, large: 3 }}
                colEnd={{ small: 13, medium: 4, large: 6 }}
                class="justify-center hidden xs:flex"
            >
                <Image
                    src={robinCoffee}
                    alt="Robin drinking coffee"
                    width={240}
                    format="webp"
                    quality={80}
                    loading="lazy"
                    decoding="async"
                    class="w-30 shrink-0"
                />
            </GridItem>
            <GridItem
                colStart={{ small: 1, medium: 5, large: 6 }}
                colEnd={{ small: 13, medium: 13, large: 11 }}
            >
                <h2 class="text-lg font-bold mb-2">What is this about?</h2>
                <p>
                    It's a quiet way to say hello, and a reminder that there are
                    people out there reading, visiting, connecting — even if
                    just for a moment. Feel free to leave a postcard!
                </p>
            </GridItem>
        </Grid>
    </Container>
</Layout>
