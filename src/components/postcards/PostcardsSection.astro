---
import { db, Postcard, desc, eq } from "astro:db";
import { Icon } from "astro-icon/components";
import PostcardsCarousel from "./PostcardsCarousel.astro";
import Container from "../Container.astro";
import HeadlineParagraphSection from "@components/HeadlineParagraphSection.astro";

export interface Props {
    limit?: number | null;
    postcards?: (typeof Postcard.$inferSelect)[];
    hasDescription?: boolean;
}

const { limit = null, postcards, hasDescription = true } = Astro.props;

let recentPostcards;

// If postcards are provided as prop, use them (with optional limit)
if (postcards) {
    recentPostcards = limit ? postcards.slice(0, limit) : postcards;
} else {
    // Otherwise, fetch from database (backward compatibility)
    let query = db
        .select()
        .from(Postcard)
        .where(eq(Postcard.isPublished, true))
        .orderBy(desc(Postcard.date));

    recentPostcards = limit ? await query.limit(limit) : await query;
}

const headline = "Postcards";
const description =
    "This website is mostly me talking. This postcard gives you a chance to talk back â€” even just a line. Drop me a postcard. Tell me what you're thinking, where you're visiting from, or simply that you stopped by. I'd love to hear from you.";
---

{
    recentPostcards.length > 0 && (
        <div>
            {hasDescription && (
                <>
                    <Container class="relative">
                        <a
                            href="/postcards/new"
                            class="inline-flex items-center gap-2 absolute right-0 -top-10 hover-lift"
                        >
                            <Icon name="new-postcard" size={100} />
                        </a>
                    </Container>

                    <HeadlineParagraphSection
                        title={headline}
                        contentEnd={11}
                        class="mb-16!"
                    >
                        {description}
                    </HeadlineParagraphSection>
                </>
            )}
            <PostcardsCarousel postcards={recentPostcards} hasLink={!!limit} />
        </div>
    )
}
