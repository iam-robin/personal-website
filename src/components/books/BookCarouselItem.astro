---
import { Icon } from "astro-icon/components";
import type { Book } from "@api/github-books";
import { getSpineColors } from "@utils/spineColors";
import StarRating from "@components/StarRating.astro";
import StatusBadge from "@components/StatusBadge.astro";

interface Props {
    book: Book;
    isCurrentlyReading?: boolean;
}

const { book, isCurrentlyReading = false } = Astro.props;

// Get spine color: prefer book data, fall back to default
const fallbackColors = getSpineColors(book.title);
const coverColor = book.spineColor || fallbackColors.background;

// Calculate book thickness based on pages
const thicknessPerPage = 0.1;
const defaultPageCount = 250;
const pageCount = book.pages || defaultPageCount;
const bookThickness = Math.max(15, Math.min(pageCount * thicknessPerPage, 40));

// Format authors
const authors = book.author.join(", ");
---

<a href="#" class="flex flex-col gap-3 h-full justify-between">
    <div class="h-full">
        <div
            class="relative bg-surface-raised rounded-lg flex-center py-20 px-4 h-full book-item"
        >
            {
                book.cover ? (
                    <div
                        class="book-3d"
                        style={`--cover-color: ${coverColor}; --book-thickness: ${bookThickness}px`}
                    >
                        <div class="book-3d__inner">
                            <img
                                class="book-3d__cover"
                                src={`/${book.cover}`}
                                alt={book.title}
                                loading="lazy"
                                onerror="this.style.opacity='0';"
                            />
                            <div class="effect" />
                            <div class="light" />
                        </div>
                    </div>
                ) : (
                    <div class="flex h-full w-full items-center justify-center text-neutral-400">
                        <Icon name="ph:book" width={48} />
                    </div>
                )
            }
            {
                isCurrentlyReading && (
                    <StatusBadge
                        status="reading"
                        class="absolute right-2 top-2"
                    />
                )
            }
        </div>
    </div>
    <div class="flex flex-col gap-.5 min-h-[100px]">
        <p class="text-text-primary text-sm leading-tight font-bold">
            {book.title}
        </p>
        <p class="text-text-secondary text-sm">{authors}</p>
        <StarRating rating={book.rating ?? 0} size={12} />
    </div>
</a>

<style>
    .book-3d {
        perspective: 1000px;
        max-width: 60%;
    }

    @media (min-width: 640px) {
        .book-3d {
            max-width: 45%;
        }
    }

    .book-3d__inner {
        position: relative;
        transform-style: preserve-3d;
        transform: rotateY(-25deg);
        transition: all 0.3s;
    }

    a:hover .book-3d__inner {
        transform: rotateY(0deg);
    }
    /* Book Pages */
    .book-3d__inner::before {
        position: absolute;
        content: "";
        left: 100%;
        top: 1%;
        width: calc(var(--book-thickness) * 2);
        height: 98%;
        transform: translate(-55%, 0) rotateY(90deg);
        background: linear-gradient(
            90deg,
            #fff 0%,
            hsl(0, 0%, 94%) 5%,
            #fff 10%,
            hsl(0, 0%, 94%) 15%,
            #fff 20%,
            hsl(0, 0%, 94%) 25%,
            #fff 30%,
            hsl(0, 0%, 94%) 35%,
            #fff 40%,
            hsl(0, 0%, 94%) 45%,
            #fff 50%,
            hsl(0, 0%, 94%) 55%,
            #fff 60%,
            hsl(0, 0%, 94%) 65%,
            #fff 70%,
            hsl(0, 0%, 94%) 75%,
            #fff 80%,
            hsl(0, 0%, 94%) 85%,
            #fff 90%,
            hsl(0, 0%, 94%) 95%,
            #fff 100%
        );
    }

    /* Rear Cover */
    .book-3d__inner::after {
        content: "";
        position: absolute;
        top: 0;
        left: 1%;
        width: 100%;
        height: 100%;
        transform: translateZ(calc(var(--book-thickness) * -1));
        background-color: var(--cover-color);
        border-radius: 0 2px 2px 0;
        box-shadow: -10px 0 50px 10px rgba(0, 0, 0, 0.2);
    }

    .book-3d__cover {
        display: block;
        width: 100%;
        height: auto;
        border-radius: 0 2px 2px 0;
        transform: translateZ(var(--book-thickness));
        box-shadow: 5px 5px 20px rgba(0, 0, 0, 0.1);
    }

    .effect {
        position: absolute;
        top: 0;
        left: 0;
        width: 20px;
        height: 100%;
        margin-left: 10px;
        border-left: 2px solid rgba(0, 0, 0, 0.06);
        background-image: linear-gradient(
            90deg,
            rgba(255, 255, 255, 0.2) 0%,
            rgba(255, 255, 255, 0) 100%
        );
        transform: translateZ(var(--book-thickness));
        transition: all 0.3s ease;
        pointer-events: none;
    }

    .light {
        position: absolute;
        top: 0;
        right: 0;
        width: 90%;
        height: 100%;
        border-radius: 0 2px 2px 0;
        background-image: linear-gradient(
            90deg,
            rgba(255, 255, 255, 0) 0%,
            rgba(255, 255, 255, 0.2) 100%
        );
        opacity: 0.1;
        transform: translateZ(var(--book-thickness));
        transition: all 0.3s ease;
        pointer-events: none;
    }

    a:hover .effect {
        width: 40px;
    }

    a:hover .light {
        opacity: 1;
        width: 70%;
    }
</style>
