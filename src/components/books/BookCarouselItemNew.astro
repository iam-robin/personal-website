---
import { Icon } from "astro-icon/components";
import type { Book } from "@api/github-books";
import { getSpineColors } from "@utils/spineColors";

interface Props {
    book: Book;
    isCurrentlyReading?: boolean;
}

const { book, isCurrentlyReading = false } = Astro.props;

// Extract spine colors at build time
let coverColor = "#4d9077"; // fallback
if (book.cover) {
    const spineColors = await getSpineColors(book.title, book.cover);
    coverColor = spineColors.background;
}

// Calculate book thickness based on pages
const thicknessPerPage = 0.1;
const defaultPageCount = 250;
const pageCount = book.pages || defaultPageCount;
const bookThickness = Math.max(15, Math.min(pageCount * thicknessPerPage, 40));

// Generate stars for rating
const rating = book.rating ?? 0;
const fullStars = Math.floor(rating);
const hasHalfStar = rating % 1 >= 0.5;
const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

// Format authors
const authors = book.author.join(", ");
---

<a href="#" class="flex flex-col gap-3 h-full justify-between">
    <div class="h-full">
        <div
            class="relative bg-surface-raised rounded-lg flex-center py-20 px-4 h-full book-item"
        >
            {
                book.cover ? (
                    <div class="book-3d" style={`--cover-color: ${coverColor}; --book-thickness: ${bookThickness}px`}>
                        <div class="book-3d__inner">
                            <img
                                class="book-3d__cover"
                                src={book.cover}
                                alt={book.title}
                            />
                        </div>
                    </div>
                ) : (
                    <div class="flex h-full w-full items-center justify-center text-neutral-400">
                        <Icon name="ph:book" width={48} />
                    </div>
                )
            }
            {
                isCurrentlyReading && (
                    <div class="absolute right-2 top-2 rounded bg-sticker-lilac px-2 py-1 text-xs text-sticker-lilac-dark">
                        Reading
                    </div>
                )
            }
        </div>
    </div>
    <div class="flex flex-col gap-.5 min-h-[100px]">
        <p class="text-text-primary text-sm leading-tight font-bold">
            {book.title}
        </p>
        <p class="text-text-secondary text-sm">{authors}</p>
        {
            rating > 0 && (
                <div class="flex items-center gap-1 mt-.5">
                    {Array.from({ length: fullStars }, (_, i) => (
                        <Icon
                            name="ph:star-fill"
                            class="text-surface-inverse"
                            width={12}
                        />
                    ))}
                    {hasHalfStar && (
                        <Icon
                            name="ph:star-half-fill"
                            class="text-surface-inverse"
                            width={12}
                        />
                    )}
                    {Array.from({ length: emptyStars }, (_, i) => (
                        <Icon
                            name="ph:star"
                            width={12}
                            class="text-surface-inverse"
                        />
                    ))}
                </div>
            )
        }
    </div>
</a>

<style>
    .book-3d {
        perspective: 1000px;
        max-width: 50%;
    }

    .book-3d__inner {
        position: relative;
        transform-style: preserve-3d;
        transform: rotateY(-25deg);
        transition: all 0.3s;
    }

    a:hover .book-3d__inner {
        transform: rotateY(0deg);
    }
    /* Book Pages */
    .book-3d__inner::before {
        position: absolute;
        content: "";
        left: 100%;
        top: 1%;
        width: calc(var(--book-thickness) * 2);
        height: 98%;
        transform: translate(-55%, 0) rotateY(90deg);
        background: linear-gradient(
            90deg,
            #fff 0%,
            hsl(0, 0%, 94%) 5%,
            #fff 10%,
            hsl(0, 0%, 94%) 15%,
            #fff 20%,
            hsl(0, 0%, 94%) 25%,
            #fff 30%,
            hsl(0, 0%, 94%) 35%,
            #fff 40%,
            hsl(0, 0%, 94%) 45%,
            #fff 50%,
            hsl(0, 0%, 94%) 55%,
            #fff 60%,
            hsl(0, 0%, 94%) 65%,
            #fff 70%,
            hsl(0, 0%, 94%) 75%,
            #fff 80%,
            hsl(0, 0%, 94%) 85%,
            #fff 90%,
            hsl(0, 0%, 94%) 95%,
            #fff 100%
        );
    }

    /* Rear Cover */
    .book-3d__inner::after {
        content: "";
        position: absolute;
        top: 0;
        left: 1%;
        width: 100%;
        height: 100%;
        transform: translateZ(calc(var(--book-thickness) * -1));
        background-color: var(--cover-color);
        border-radius: 0 2px 2px 0;
        box-shadow: -10px 0 50px 10px rgba(0, 0, 0, 0.2);
    }

    .book-3d__cover {
        display: block;
        width: 100%;
        height: auto;
        border-radius: 0 2px 2px 0;
        transform: translateZ(var(--book-thickness));
        box-shadow: 5px 5px 20px rgba(0, 0, 0, 0.1);
    }
</style>
