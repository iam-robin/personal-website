---
import { Icon } from "astro-icon/components";
import NavLink from "./NavLink.astro";
import NavGroup from "./NavGroup.astro";
import MobileMenu from "./MobileMenu.astro";
import ThemeSwitcher from "./ThemeSwitcher.astro";
import Container from "@components/Container.astro";

const isIndexPage = Astro.url.pathname === "/";

const navigation = [
    {
        type: "group" as const,
        label: "Media logs",
        items: [
            {
                label: "Books",
                href: "/books",
                sticker: "books",
                external: false,
            },
            {
                label: "Movies",
                href: "/movies",
                sticker: "movie",
                external: false,
            },
            {
                label: "TV shows",
                href: "/series",
                sticker: "tv-series",
                external: false,
            },
            {
                label: "Music",
                href: "/music",
                sticker: "music",
                external: false,
            },
        ],
    },
    // {
    //     type: "link" as const,
    //     label: "About",
    //     href: "/about",
    // },
    {
        type: "link" as const,
        label: "Bookmarks",
        href: "/bookmarks",
    },
    {
        type: "link" as const,
        label: "Postcards",
        href: "/postcards",
    },
    {
        type: "link" as const,
        label: "Garden",
        href: "/garden",
    },
    {
        type: "link" as const,
        label: "Blog",
        href: "/blog",
    },
    {
        type: "link" as const,
        label: "Photos",
        href: "https://robins.photos",
        external: true,
    },
];
---

<header
    id="site-header"
    data-index-page={isIndexPage ? "true" : undefined}
    class:list={[
        "sticky top-0 z-20 mt-4 md:mt-8 border-border",
        { "bg-surface": isIndexPage },
    ]}
>
    <Container>
        <div class="flex items-center justify-between h-16">
            <!-- Logo -->
            <a
                href="/"
                id="site-logo"
                class="text-md font-bold hover:text-neutral-500 transition-colors hover:italic min-w-24"
            >
                <p class="leading-none">
                    i<span class="logo-space w-1 inline-block"></span>am
                </p>
                <p class="logo-robin leading-none -mt-1.5 ml-5">robin</p>
            </a>

            <!-- Desktop Navigation -->
            <nav class="hidden md:flex items-center gap-6">
                {
                    navigation.map((item) =>
                        item.type === "link" ? (
                            <NavLink
                                label={item.label}
                                href={item.href!}
                                external={item.external}
                            />
                        ) : (
                            <NavGroup label={item.label} items={item.items!} />
                        ),
                    )
                }
            </nav>

            <ThemeSwitcher />
        </div>
    </Container>
</header>

<!-- Mobile Menu -->
<MobileMenu navigation={navigation} />

<script>
    // Module-level flag - persists across view transitions, resets on full page load
    let hasAnimated = false;

    function initHeader() {
        const header = document.getElementById("site-header");
        const logo = document.getElementById("site-logo");
        const logoRobin = document.getElementsByClassName("logo-robin");
        const logoSpace = document.getElementsByClassName("logo-space");

        if (!header || !logo) return;

        // Use the margin-top value (mt-8 = 32px) as the sticky threshold
        const stickyThreshold = 32;
        const isSticky = window.scrollY >= stickyThreshold;
        const isIndexPage = header.dataset.indexPage === "true";
        const isDesktop = window.matchMedia("(min-width: 768px)").matches;

        if (!hasAnimated && isIndexPage && !isSticky && isDesktop) {
            // First visit to index page, not scrolled, desktop - trigger CSS animation
            hasAnimated = true;
            header.classList.add("header-animate");
        } else {
            // Already animated, other pages, scrolled, or mobile - show immediately
            hasAnimated = true;
            header.classList.add("header-visible");
        }

        function updateHeaderStyle() {
            const isSticky = window.scrollY >= stickyThreshold;

            if (isSticky) {
                header?.classList.add("border-b", "bg-background");
                header?.classList.remove("bg-surface");
                logo?.classList.add("flex");
                logoRobin[0]?.classList.remove("-mt-1.5", "ml-5");
                logoSpace[0]?.classList.remove("w-1");
            } else {
                header?.classList.remove("border-b", "bg-background");
                logo?.classList.remove("flex");
                logoRobin[0]?.classList.add("-mt-1.5", "ml-5");
                logoSpace[0]?.classList.add("w-1");
            }
        }

        // Initial check
        updateHeaderStyle();

        // Listen for scroll
        window.addEventListener("scroll", updateHeaderStyle);
    }

    // For view transitions (navigation between pages)
    document.addEventListener("astro:page-load", initHeader);

    // For direct page loads - run immediately if DOM is ready
    if (document.readyState !== "loading") {
        initHeader();
    }
</script>

<style is:global>
    /* Header animation keyframes */
    @keyframes headerSlideIn {
        from {
            opacity: 0;
            transform: translateY(-100%);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Initial state - hidden until JS adds a class */
    #site-header:not(.header-visible):not(.header-animate) {
        opacity: 0;
        transform: translateY(-100%);
    }

    /* Animated entrance (index page, desktop, first visit) */
    /* Using 'both' fill-mode keeps first keyframe styles during delay */
    #site-header.header-animate {
        animation: headerSlideIn 0.5s cubic-bezier(0.39, 0.24, 0.3, 1) 1.5s both;
    }

    /* Immediate visibility (other pages or return visits) */
    #site-header.header-visible {
        opacity: 1;
        transform: translateY(0);
    }

    /* When JS is disabled, show header immediately */
    html:not(.js) #site-header {
        opacity: 1 !important;
        transform: translateY(0) !important;
    }
</style>
