---
import { Icon } from "astro-icon/components";
import NavLink from "./NavLink.astro";
import NavGroup from "./NavGroup.astro";
import MobileMenu from "./MobileMenu.astro";
import ThemeSwitcher from "./ThemeSwitcher.astro";
import Container from "@components/Container.astro";

const isIndexPage = Astro.url.pathname === "/";

const navigation = [
    {
        type: "group" as const,
        label: "Media logs",
        items: [
            {
                label: "Books",
                href: "/books",
                sticker: "books",
                external: false,
            },
            {
                label: "Movies",
                href: "/movies",
                sticker: "movie",
                external: false,
            },
            {
                label: "TV shows",
                href: "/series",
                sticker: "tv-series",
                external: false,
            },
            // {
            //     label: "Music",
            //     href: "/music",
            //     sticker: "music",
            //     external: false,
            // },
        ],
    },
    // {
    //     type: "link" as const,
    //     label: "About",
    //     href: "/about",
    // },
    {
        type: "link" as const,
        label: "Bookmarks",
        href: "/bookmarks",
    },
    {
        type: "link" as const,
        label: "Postcards",
        href: "/postcards",
    },
    {
        type: "link" as const,
        label: "Garden",
        href: "/garden",
    },
    {
        type: "link" as const,
        label: "Blog",
        href: "/blog",
    },
    {
        type: "link" as const,
        label: "Photos",
        href: "https://robins.photos",
        external: true,
    },
];
---

<header
    id="site-header"
    class:list={[
        "sticky top-0 z-20 mt-4 md:mt-8 border-border opacity-0 -translate-y-full",
        { "bg-surface": isIndexPage },
    ]}
>
    <Container>
        <div class="flex items-center justify-between h-16">
            <!-- Logo -->
            <a
                href="/"
                id="site-logo"
                class="text-md font-bold hover:text-neutral-500 transition-colors hover:italic min-w-24"
            >
                <p class="leading-none">
                    i<span class="logo-space w-1 inline-block"></span>am
                </p>
                <p class="logo-robin leading-none -mt-1.5 ml-5">robin</p>
            </a>

            <!-- Desktop Navigation -->
            <nav class="hidden md:flex items-center gap-6">
                {
                    navigation.map((item) =>
                        item.type === "link" ? (
                            <NavLink
                                label={item.label}
                                href={item.href!}
                                external={item.external}
                            />
                        ) : (
                            <NavGroup label={item.label} items={item.items!} />
                        ),
                    )
                }
            </nav>

            <ThemeSwitcher />
        </div>
    </Container>
</header>

<!-- Mobile Menu -->
<MobileMenu navigation={navigation} />

<script>
    import { animate } from "motion";

    // Module-level flag - persists across view transitions, resets on full page load
    let hasAnimated = false;

    function initHeader() {
        const header = document.getElementById("site-header");
        const logo = document.getElementById("site-logo");
        const logoRobin = document.getElementsByClassName("logo-robin");
        const logoSpace = document.getElementsByClassName("logo-space");

        if (!header || !logo) return;

        // Use the margin-top value (mt-8 = 32px) as the sticky threshold
        const stickyThreshold = 32;
        const isSticky = window.scrollY >= stickyThreshold;

        if (hasAnimated) {
            // Already animated this session - just show header immediately
            header.classList.remove("opacity-0", "-translate-y-full");
        } else {
            hasAnimated = true;
            const isIndexPage = window.location.pathname === "/";
            const isDesktop = window.matchMedia("(min-width: 768px)").matches;

            if (isIndexPage && !isSticky && isDesktop) {
                // Index page, not scrolled, desktop - play delayed animation
                header.classList.remove("opacity-0", "-translate-y-full");
                header.style.opacity = "0";
                header.style.transform = "translateY(-100%)";

                animate(
                    header,
                    {
                        opacity: [0, 1],
                        transform: ["translateY(-100%)", "translateY(0%)"],
                    },
                    { duration: 0.5, delay: 1.5, ease: [0.39, 0.24, 0.3, 1] },
                ).then(() => {
                    header.style.opacity = "";
                    header.style.transform = "";
                });
            } else {
                // Other pages, scrolled, or mobile - show immediately
                header.classList.remove("opacity-0", "-translate-y-full");
            }
        }

        function updateHeaderStyle() {
            const isSticky = window.scrollY >= stickyThreshold;

            if (isSticky) {
                header?.classList.add("border-b", "bg-background");
                header?.classList.remove("bg-surface");
                logo?.classList.add("flex");
                logoRobin[0]?.classList.remove("-mt-1.5", "ml-5");
                logoSpace[0]?.classList.remove("w-1");
            } else {
                header?.classList.remove("border-b", "bg-background");
                logo?.classList.remove("flex");
                logoRobin[0]?.classList.add("-mt-1.5", "ml-5");
                logoSpace[0]?.classList.add("w-1");
            }
        }

        // Initial check
        updateHeaderStyle();

        // Listen for scroll
        window.addEventListener("scroll", updateHeaderStyle);
    }

    // For view transitions (navigation between pages)
    document.addEventListener("astro:page-load", initHeader);

    // For direct page loads - run immediately if DOM is ready
    if (document.readyState !== "loading") {
        initHeader();
    }
</script>

<style>
    /* When JS is disabled, show header immediately (override Tailwind hiding classes) */
    html:not(.js) #site-header {
        opacity: 1 !important;
        --tw-translate-y: 0 !important;
    }
</style>
