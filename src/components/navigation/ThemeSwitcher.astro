---

---

<button
    id="theme-switcher"
    class="p-2 cursor-pointer"
    aria-label="Toggle theme"
>
    <div
        class="theme-icon h-4 w-4 bg-foreground rounded-full"
        data-theme-icon="light"
    >
    </div>
    <div
        class="theme-icon h-4 w-4 bg-foreground rounded-full hidden"
        data-theme-icon="dark"
    >
    </div>
</button>

<script>
    function initThemeSwitcher() {
        const button = document.getElementById("theme-switcher");
        if (!button) return;

        const themes = [null, "dark"] as const;
        type Theme = (typeof themes)[number];

        function getStoredTheme(): Theme {
            const stored = localStorage.getItem("theme");
            if (stored === "dark") return stored;
            return null;
        }

        function setTheme(theme: Theme) {
            if (theme) {
                document.documentElement.dataset.theme = theme;
                localStorage.setItem("theme", theme);
            } else {
                delete document.documentElement.dataset.theme;
                localStorage.removeItem("theme");
            }
            updateIcon(theme);
        }

        function updateIcon(theme: Theme) {
            const icons = button!.querySelectorAll(".theme-icon");
            icons.forEach((icon) => {
                const iconTheme = (icon as HTMLElement).dataset.themeIcon;
                if (
                    (theme === null && iconTheme === "light") ||
                    iconTheme === theme
                ) {
                    icon.classList.remove("hidden");
                } else {
                    icon.classList.add("hidden");
                }
            });
        }

        function cycleTheme() {
            const current = getStoredTheme();
            const currentIndex = themes.indexOf(current);
            const nextIndex = (currentIndex + 1) % themes.length;
            console.log(
                "cycle theme",
                current,
                currentIndex,
                nextIndex,
                themes[nextIndex]
            );
            setTheme(themes[nextIndex]);
        }

        // Initialize with stored theme
        const storedTheme = getStoredTheme();
        setTheme(storedTheme);

        // Handle click - only add listener once per button instance
        if (!button.dataset.initialized) {
            button.dataset.initialized = "true";
            button.addEventListener("click", cycleTheme);
        }
    }

    // Run on initial load AND after Astro page transitions
    document.addEventListener("astro:page-load", initThemeSwitcher);
</script>
