---
import { Icon } from 'astro-icon/components';
import { getAllContentCounts } from '@utils/content-counts';
import { Image } from 'astro:assets';
import StickerLogo from '@assets/sticker-logo.svg';
import NavFlyoutMock from '@assets/nav-flyout-mock.png';
import NavFlyoutMock2 from '@assets/nav-flyout-mock-2.png';

interface NavItem {
    name: string;
    path: string;
    icon: string;
    iconBg: string;
    iconColor: string;
    countKey: keyof typeof counts;
    description: string;
    teaserImage: ImageMetadata;
}

// Fetch content counts only during build, use mock data in development
const counts = import.meta.env.DEV
    ? {
          books: 12,
          bookmarks: 45,
          postcards: 8,
          garden: 23,
          blog: 15,
          photos365: 180
      }
    : await getAllContentCounts();

export const navData: NavItem[] = [
    {
        name: 'Books',
        path: '/media',
        icon: 'ph:book-fill',
        iconBg: 'bg-red',
        iconColor: 'text-red-dark',
        countKey: 'books',
        description:
            "What I've been reading lately — books, audiobooks, and the occasional guilty pleasure that made me think.",
        teaserImage: NavFlyoutMock
    },
    {
        name: 'Bookmarks',
        path: '/bookmarks',
        icon: 'ph:bookmark-fill',
        iconBg: 'bg-blue',
        iconColor: 'text-blue-dark',
        countKey: 'bookmarks',
        description:
            "Links I've saved because they taught me something or made me curious enough to share.",
        teaserImage: NavFlyoutMock2
    },
    {
        name: 'Postcards',
        path: '/postcards',
        icon: 'ph:stamp-fill',
        iconBg: 'bg-lilac',
        iconColor: 'text-lilac-dark',
        countKey: 'postcards',
        description:
            'An interactive map where you can leave digital postcards — because the internet needs more genuine human connection.',
        teaserImage: NavFlyoutMock
    },
    {
        name: 'Garden',
        path: '/garden',
        icon: 'ph:plant-fill',
        iconBg: 'bg-green',
        iconColor: 'text-green-dark',
        countKey: 'garden',
        description:
            'Growing thoughts and half-formed ideas that might bloom into something useful (or at least interesting).',
        teaserImage: NavFlyoutMock2
    },
    {
        name: 'Blog',
        path: '/blog',
        icon: 'ph:article-fill',
        iconBg: 'bg-yellow',
        iconColor: 'text-yellow-dark',
        countKey: 'blog',
        description:
            'Longer thoughts on design, technology, and whatever else catches my attention long enough to write about.',
        teaserImage: NavFlyoutMock
    },
    {
        name: '365 project',
        path: '/365',
        icon: 'ph:calendar-fill',
        iconBg: 'bg-red',
        iconColor: 'text-red-dark',
        countKey: 'photos365',
        description:
            'A daily photo journal documenting life through my camera lens — the mundane, beautiful, and everything in between.',
        teaserImage: NavFlyoutMock2
    }
];
---

<aside
    class="sidebar-main fixed top-0 bottom-0 p-8 z-50 text-white transition-[width,padding] duration-300 ease-in-out flex flex-col justify-between"
>
    <div class="relative">
        <div class="min-h-16">
            <a href="/" class="flex gap-3 flex-col items-center">
                <Image
                    src={StickerLogo}
                    alt="Holographic sticker of my face"
                    widths={[128]}
                    sizes={`128px`}
                    class="max-w-[72px] sticker-logo transition-[max-width, margin] duration-300 ease-in-out"
                    data-rarity="common"
                />
                <div class="text-nowrap logo-text transition-opacity duration-300 ease-in-out">
                    <p class="text-sm font-bold text-white-900">Robin Spielmann</p>
                    <p class="text-xs font-mono text-white-600 tight-word-spacing">
                        Design Engineer
                    </p>
                </div>
            </a>
        </div>
        <div class="absolute -right-24 top-0 bg-red rounded-md p-2">
            <Icon name="ph:sidebar" class="text-gray-800 w-6 h-6" />
            <button
                id="sidebar-toggle"
                class="absolute inset-0 w-full h-full opacity-0"
                aria-label="Toggle sidebar"
            >
            </button>
        </div>

        <nav class="mt-32">
            <ul class="space-y-4">
                {
                    navData.map((item) => (
                        <li
                            class="relative nav-item"
                            data-title={item.name}
                            data-description={item.description}
                        >
                            <a
                                href={item.path}
                                class="flex gap-3 items-center justify-between group hover:bg-white/5 rounded-md p-2 -m-2 transition-colors"
                            >
                                <div class="flex items-center gap-3 min-w-0 flex-1">
                                    <div
                                        class={`w-6 h-6 p-0.5 ${item.iconBg} flex items-center justify-center rounded flex-shrink-0`}
                                    >
                                        <Icon name={item.icon} class={item.iconColor} />
                                    </div>
                                    <span class="nav-text transition-opacity duration-300 ease-in-out whitespace-nowrap overflow-hidden">
                                        {item.name}
                                    </span>
                                </div>
                                <span class="nav-count opacity-30 transition-opacity duration-300 ease-in-out flex-shrink-0">
                                    ({counts[item.countKey]})
                                </span>
                            </a>
                        </li>
                    ))
                }
            </ul>
        </nav>

        <!-- Shared navigation flyout -->
        <div
            id="nav-flyout"
            class="absolute left-full ml-10 bg-[#101827] border text-white border-[#394762] rounded-lg opacity-0 pointer-events-none w-72 p-4 z-50 transition-all duration-200 ease-out"
        >
            <div id="nav-flyout-images" class="relative w-full h-20 rounded mb-3 overflow-hidden">
                {
                    navData.map((item, index) => (
                        <Image
                            id={`nav-flyout-image-${index}`}
                            src={item.teaserImage}
                            alt={`${item.name} section preview`}
                            class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-200"
                            widths={[288]}
                            sizes="288px"
                        />
                    ))
                }
            </div>
            <div id="nav-flyout-title" class="text-base font-semibold mb-2"></div>
            <div id="nav-flyout-content" class="text-sm leading-relaxed"></div>
            <!-- Triangle pointer with border -->
            <div
                class="absolute right-full top-1/2 -translate-y-1/2 w-0 h-0 border-t-[8.5px] border-t-transparent border-b-[8.5px] border-b-transparent border-r-[8.5px] border-r-[#394762]"
            >
            </div>
            <!-- Triangle pointer fill -->
            <div
                class="absolute right-full top-1/2 -translate-y-1/2 translate-x-[0.8px] w-0 h-0 border-t-[8px] border-t-transparent border-b-[8px] border-b-transparent border-r-[8px] border-r-[#101827]"
            >
            </div>
        </div>
    </div>
    <div class="footer-container relative">
        <!-- Toggle button for collapsed state -->
        <button
            id="footer-toggle"
            class="footer-toggle-btn flex items-center justify-center w-8 h-8 rounded-md hover:bg-white/10 transition-colors opacity-0 pointer-events-none"
            aria-label="Footer menu"
        >
            <Icon name="ph:dots-three" class="w-5 h-5" />
        </button>

        <!-- Direct links for expanded state -->
        <ul class="footer-links transition-opacity duration-300 ease-in-out">
            <li><a href="/legal" class="hover:text-white/80 transition-colors">Legal notice</a></li>
            <li>
                <a href="/changelog" class="hover:text-white/80 transition-colors">Changelog</a>
            </li>
            <li>
                <a
                    href="https://github.com/iam-robin/personal-website"
                    class="hover:text-white/80 transition-colors">Source code</a
                >
            </li>
        </ul>

        <!-- Flyout menu for collapsed state -->
        <div
            id="footer-flyout"
            class="footer-flyout absolute bottom-0 left-full ml-4 bg-[#433e3c] border border-white/10 rounded-md p-2 min-w-[160px] opacity-0 pointer-events-none transition-opacity duration-200 z-[9999]"
        >
            <ul class="space-y-1">
                <li>
                    <a
                        href="/legal"
                        class="block px-2 py-1 text-sm hover:bg-white/10 rounded transition-colors"
                        >Legal notice</a
                    >
                </li>
                <li>
                    <a
                        href="/changelog"
                        class="block px-2 py-1 text-sm hover:bg-white/10 rounded transition-colors"
                        >Changelog</a
                    >
                </li>
                <li>
                    <a
                        href="https://github.com/iam-robin/personal-website"
                        class="block px-2 py-1 text-sm hover:bg-white/10 rounded transition-colors"
                        >Source code</a
                    >
                </li>
            </ul>
        </div>
    </div>
</aside>

<script>
    // Sidebar collapse functionality
    function initSidebar() {
        const toggleButton = document.getElementById('sidebar-toggle');
        const body = document.body;

        // Check localStorage for saved state
        const isCollapsed = localStorage.getItem('sidebar-collapsed') === 'true';
        if (isCollapsed) {
            body.classList.add('sidebar-collapsed');
        }

        // Toggle function
        function toggleSidebar() {
            const isCurrentlyCollapsed = body.classList.contains('sidebar-collapsed');

            if (isCurrentlyCollapsed) {
                body.classList.remove('sidebar-collapsed');
                localStorage.setItem('sidebar-collapsed', 'false');
            } else {
                body.classList.add('sidebar-collapsed');
                localStorage.setItem('sidebar-collapsed', 'true');
            }
        }

        // Add event listener
        if (toggleButton) {
            toggleButton.addEventListener('click', toggleSidebar);
        }
    }

    // Initialize when DOM is loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initSidebar);
    } else {
        initSidebar();
    }

    // Footer flyout functionality
    function initFooterFlyout() {
        const footerToggle = document.getElementById('footer-toggle');
        const footerFlyout = document.getElementById('footer-flyout');

        if (!footerToggle || !footerFlyout) return;

        let isOpen = false;

        function toggleFlyout() {
            isOpen = !isOpen;
            if (isOpen) {
                footerFlyout!.classList.remove('opacity-0', 'pointer-events-none');
            } else {
                footerFlyout!.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        function closeFlyout() {
            if (isOpen) {
                isOpen = false;
                footerFlyout!.classList.add('opacity-0', 'pointer-events-none');
            }
        }

        // Toggle on button click
        footerToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleFlyout();
        });

        // Close on outside click
        document.addEventListener('click', (e) => {
            const target = e.target as Element;
            if (!footerToggle.contains(target) && !footerFlyout!.contains(target)) {
                closeFlyout();
            }
        });

        // Close when sidebar is expanded
        const sidebarToggle = document.getElementById('sidebar-toggle');
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', closeFlyout);
        }
    }

    // Initialize footer flyout when DOM is loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initFooterFlyout);
    } else {
        initFooterFlyout();
    }

    // Navigation flyout functionality
    function initNavFlyout() {
        const navItems = document.querySelectorAll('.nav-item');
        const flyout = document.getElementById('nav-flyout');
        const flyoutTitle = document.getElementById('nav-flyout-title');
        const flyoutContent = document.getElementById('nav-flyout-content');

        if (!flyout || !flyoutTitle || !flyoutContent) return;

        let currentItem = null;

        navItems.forEach((navItem, index) => {
            navItem.addEventListener('mouseenter', () => {
                const title = navItem.getAttribute('data-title');
                const description = navItem.getAttribute('data-description');

                // Update content
                flyoutTitle.textContent = title;
                flyoutContent.textContent = description;

                // Show the correct image and hide others
                const images = document.querySelectorAll('[id^="nav-flyout-image-"]');
                images.forEach((img, imgIndex) => {
                    if (imgIndex === index) {
                        img.classList.remove('opacity-0');
                        img.classList.add('opacity-100');
                    } else {
                        img.classList.remove('opacity-100');
                        img.classList.add('opacity-0');
                    }
                });

                // Position the flyout relative to the nav item
                const navRect = navItem.getBoundingClientRect();
                const sidebar = document.querySelector('.sidebar-main');
                const sidebarRect = sidebar?.getBoundingClientRect();

                if (sidebarRect) {
                    const relativeTop = navRect.top - sidebarRect.top - 10;

                    flyout.style.top = `${relativeTop}px`;
                    flyout.style.transform = 'translateY(-50%)';
                }

                // Show the flyout
                flyout.classList.remove('opacity-0', 'pointer-events-none');

                currentItem = navItem;
            });

            navItem.addEventListener('mouseleave', (e) => {
                // Small delay to allow moving to flyout
                setTimeout(() => {
                    if (!flyout.matches(':hover') && currentItem === navItem) {
                        flyout.classList.add('opacity-0', 'pointer-events-none');
                        currentItem = null;
                    }
                }, 100);
            });
        });

        // Keep flyout open when hovering over it
        flyout.addEventListener('mouseenter', () => {
            flyout.classList.remove('opacity-0', 'pointer-events-none');
        });

        flyout.addEventListener('mouseleave', () => {
            flyout.classList.add('opacity-0', 'pointer-events-none');
            currentItem = null;
        });
    }

    // Initialize navigation flyout when DOM is loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initNavFlyout);
    } else {
        initNavFlyout();
    }
</script>

<style>
    /* Sidebar default width using custom property */
    .sidebar-main {
        width: var(--sidebar-width);
    }
    /* Collapsed state styles - These cannot be converted to Tailwind since they depend on body class */
    body.sidebar-collapsed .sidebar-main {
        width: var(--sidebar-width-collapsed);
        padding-left: 1.5rem;
        padding-right: 1.5rem;
        overflow: visible;
    }

    body.sidebar-collapsed .logo-text,
    body.sidebar-collapsed .nav-text,
    body.sidebar-collapsed .nav-count,
    body.sidebar-collapsed .footer-links {
        opacity: 0;
        pointer-events: none;
    }

    body.sidebar-collapsed .footer-links {
        height: 0;
    }

    /* Footer toggle button - show only when collapsed */
    body.sidebar-collapsed .footer-toggle-btn {
        opacity: 1;
        pointer-events: auto;
    }

    /* Make sticker logo smaller when collapsed */
    body.sidebar-collapsed .sticker-logo {
        max-width: 40px;
        margin-left: -4px;
    }

    /* Reduce word spacing between Design and Engineer */
    .tight-word-spacing {
        word-spacing: -0.2em;
    }
</style>
