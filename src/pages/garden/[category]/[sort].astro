---
import GardenPage from "@components/garden/GardenPage.astro";
import { fetchNotes, getCategories, type Note } from "@api/github-notes";

export async function getStaticPaths() {
    const notesData = await fetchNotes();
    const categories = getCategories(notesData);

    // Build category info with counts, sorted by count for consistent color assignment
    const categoryInfoList = categories
        .map((cat) => ({
            name: cat,
            count: (notesData[cat] as Note[])?.length || 0,
        }))
        .sort((a, b) => b.count - a.count);

    // Create a map of category to index based on sorted order for consistent coloring
    const categoryIndexMap: Record<string, number> = {};
    categoryInfoList.forEach((cat, index) => {
        categoryIndexMap[cat.name] = index;
    });

    // Generate paths for all category + sort combinations
    const sortOptions = ["newest", "last-edited", "alphabetical"] as const;
    const paths: {
        params: { category: string; sort: string };
        props: {
            category: string;
            notes: Note[];
            allCategories: typeof categoryInfoList;
            categoryIndexMap: Record<string, number>;
            selectedSort: "newest" | "last-edited" | "alphabetical";
        };
    }[] = [];

    for (const category of categories) {
        const categoryNotes = (notesData[category] as Note[]) || [];

        for (const sort of sortOptions) {
            // Sort notes based on the sort option
            const sortedNotes = [...categoryNotes].sort((a, b) => {
                if (sort === "newest") {
                    return (
                        new Date(b.created).getTime() -
                        new Date(a.created).getTime()
                    );
                }
                if (sort === "alphabetical") {
                    return a.title.localeCompare(b.title);
                }
                return (
                    new Date(b.edited).getTime() - new Date(a.edited).getTime()
                );
            });

            paths.push({
                params: {
                    category: category.toLowerCase(),
                    sort,
                },
                props: {
                    category,
                    notes: sortedNotes,
                    allCategories: categoryInfoList,
                    categoryIndexMap,
                    selectedSort: sort,
                },
            });
        }
    }

    return paths;
}

const { category, notes, allCategories, categoryIndexMap, selectedSort } =
    Astro.props;
---

<GardenPage
    notes={notes}
    allCategories={allCategories}
    categoryIndexMap={categoryIndexMap}
    selectedCategory={category}
    selectedSort={selectedSort}
/>
