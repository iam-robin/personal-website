---
import { db, Postcard } from 'astro:db';
import Layout from '@layouts/Layout.astro';
export const prerender = false;

// Define color arrays (same as in PostcardItem.astro)
const penColors = [
    '#000000', // Black
    '#0A3161', // Navy Blue
    '#00356B', // Dark Blue
    '#1F3A3D', // Dark Teal
    '#2E5090', // Royal Blue
    '#3B2F2F' // Dark Brown
];

const paperColors = [
    '#FCFAF7', // Off-white
    '#FAF9F6', // Eggshell
    '#F9F8F4', // Lighter Cream
    '#F8F7F2', // Pale Parchment
    '#F9F6F0', // Soft Ivory
    '#F8F6F2', // Pale Beige
    '#F7F4EF', // Lighter Antique
    '#F2F0E6' // Soft Ecru
];

// Process form submission
if (Astro.request.method === 'POST') {
    const formData = await Astro.request.formData();
    const author = formData?.get('author');
    const body = formData?.get('body');
    const date = new Date();
    const isPublished = true;

    // Generate random style values
    const randomMarginBottom = Math.floor(Math.random() * 8);
    const randomMarginRight = Math.floor(Math.random() * 8);
    const randomRotation = Math.floor(Math.random() * 4 - 2);

    // Select random colors
    const randomPenColorIndex = Math.floor(Math.random() * penColors.length);
    const penColor = penColors[randomPenColorIndex];
    const randomPaperColorIndex = Math.floor(Math.random() * paperColors.length);
    const paperColor = paperColors[randomPaperColorIndex];

    // Font size and line height
    const fontSizeFactor = 0.9 + Math.random() * 0.2;
    const lineHeightFactor = 1.1 + Math.random() * 0.4;

    // Author positioning
    const authorLeftOffset = Math.floor(Math.random() * 10) - 5;
    const authorTopOffset = Math.floor(Math.random() * 6) - 3;
    const authorRotation = Math.floor(Math.random() * 6) - 3;

    // Date positioning
    const dateLeftOffset = Math.floor(Math.random() * 10) - 5;
    const dateTopOffset = Math.floor(Math.random() * 6) - 3;
    const dateRotation = Math.floor(Math.random() * 6) - 3;

    // Body positioning
    const bodyLeftOffset = Math.floor(Math.random() * 8) - 4;
    const bodyTopOffset = Math.floor(Math.random() * 8) - 4;
    const bodyRotation = Math.floor(Math.random() * 4) - 2;

    if (typeof author === 'string' && typeof body === 'string') {
        await db.insert(Postcard).values({
            author,
            body,
            date,
            isPublished,
            // Store all the style values
            marginBottom: randomMarginBottom,
            marginRight: randomMarginRight,
            rotation: randomRotation,
            penColor,
            paperColor,
            fontSizeFactor,
            lineHeight: lineHeightFactor,
            authorLeftOffset,
            authorTopOffset,
            authorRotation,
            dateLeftOffset,
            dateTopOffset,
            dateRotation,
            bodyLeftOffset,
            bodyTopOffset,
            bodyRotation
        });

        // Redirect to postcards page after submission
        return Astro.redirect('/postcards');
    }
}
---

<Layout title="Send a Postcard">
    <div class="container max-w-md mx-auto pt-40 pb-20 px-4">
        <h1 class="text-2xl font-bold mb-8">Send a Postcard</h1>

        <form method="POST" class="flex flex-col space-y-6">
            <div class="flex flex-col">
                <label for="author" class="mb-1 font-medium">Your Name</label>
                <input
                    id="author"
                    name="author"
                    required
                    class="border border-black-200 p-2 rounded"
                />
            </div>

            <div class="flex flex-col">
                <label for="body" class="mb-1 font-medium">Your Message</label>
                <textarea
                    id="body"
                    name="body"
                    rows="6"
                    required
                    class="border border-black-200 p-2 rounded"></textarea>
            </div>

            <button
                type="submit"
                class="bg-black text-white py-2 px-4 rounded hover:bg-black-700 transition"
            >
                Send Postcard
            </button>
        </form>
    </div>
</Layout>
